generator client {
  provider = "prisma-client-js"
}

// Database configuration
// DATABASE_URL is loaded from environment-specific .env files:
// - .env.development (Docker local database)
// - .env.production (Neon cloud database)
// - .env.test (Docker test database)
// The correct file is loaded automatically based on NODE_ENV via dotenv-cli
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Optional: Enable connection pooling for production
  // directUrl = env("DIRECT_URL") // For migrations in production
}

model Rol {
  idRol     Int       @id @default(autoincrement()) @map("idRol")
  nombreRol RolNombre @unique @map("nombreRol")
  usuarios  Usuario[]

  @@map("Rol")
}

model AuditLog {
  idAuditLog Int      @id @default(autoincrement())
  actorId    Int
  action     String // e.g., "PATIENT_UPDATE", "PATIENT_CREATE", "PATIENT_DELETE"
  entity     String // e.g., "Patient", "Appointment", "User"
  entityId   Int
  ip         String?
  metadata   Json? // Store diff and other contextual data
  createdAt  DateTime @default(now())

  actor Usuario @relation(fields: [actorId], references: [idUsuario])

  @@index([actorId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

/// *
/// * Tabla Usuarios
model Usuario {
  idUsuario                           Int                        @id @default(autoincrement()) @map("idUsuario")
  usuario                             String                     @unique @map("usuario")
  email                               String?                    @unique @map("email")
  passwordHash                        String
  nombreApellido                      String                     @map("nombre_apellido")
  rolId                               Int                        @map("Rol_idRol")
  createdAt                           DateTime                   @default(now()) @map("created_at")
  updatedAt                           DateTime                   @updatedAt @map("updated_at")
  estaActivo                          Boolean                    @default(true) @map("esta_activo")
  ultimoLoginAt                       DateTime?                  @map("ultimo_login_at")
  profesional                         Profesional?
  rol                                 Rol                        @relation(fields: [rolId], references: [idRol])
  citasCreadas                        Cita[]                     @relation("CitaCreadaPor")
  citasCanceladas                     Cita[]                     @relation("CitaCanceladaPor")
  CitaEstadoHistorial                 CitaEstadoHistorial[]
  BloqueoAgenda                       BloqueoAgenda[]
  Consulta                            Consulta[]
  ConsultaAdjunto                     Adjunto[]
  TreatmentPlan                       TreatmentPlan[]
  ClinicalHistoryEntry                ClinicalHistoryEntry[]
  PatientDiagnosis                    PatientDiagnosis[]
  PatientAllergy                      PatientAllergy[]
  PatientMedication                   PatientMedication[]        @relation("PatientMedicationCreatedBy")
  PatientMedicationUpdatedBy          PatientMedication[]        @relation("PatientMedicationUpdatedBy")
  PatientMedicationDiscontinuedBy     PatientMedication[]        @relation("PatientMedicationDiscontinuedBy")
  PatientVitals                       PatientVitals[]
  OdontogramSnapshot                  OdontogramSnapshot[]
  PeriodontogramSnapshot              PeriodontogramSnapshot[]
  Adjunto                             Adjunto[]                  @relation("AdjuntoUploadedBy")
  consentimientosRegistrados          Consentimiento[]
  PatientAnamnesis                    PatientAnamnesis[]         @relation("AnamnesisCreadaPor")
  PatientAnamnesisActualizada         PatientAnamnesis[]         @relation("AnamnesisActualizadaPor")
  PatientAnamnesisVersion             PatientAnamnesisVersion[]
  AnamnesisConfig                     AnamnesisConfig[]
  AuditLog                            AuditLog[]
  AnamnesisMedicationAddedBy          AnamnesisMedication[]      @relation("AnamnesisMedicationAddedBy")
  AnamnesisMedicationRemovedBy        AnamnesisMedication[]      @relation("AnamnesisMedicationRemovedBy")
  AnamnesisAllergyAddedBy             AnamnesisAllergy[]         @relation("AnamnesisAllergyAddedBy")
  AnamnesisAllergyRemovedBy           AnamnesisAllergy[]         @relation("AnamnesisAllergyRemovedBy")
  AnamnesisMedicationAuditPerformedBy AnamnesisMedicationAudit[] @relation("AnamnesisMedicationAuditPerformedBy")
  AnamnesisAllergyAuditPerformedBy    AnamnesisAllergyAudit[]    @relation("AnamnesisAllergyAuditPerformedBy")
  DiagnosisStatusHistoryChangedBy     DiagnosisStatusHistory[]   @relation("DiagnosisStatusHistoryChangedBy")
  AnamnesisAuditLogActor              AnamnesisAuditLog[]        @relation("AnamnesisAuditLogActor")
  AnamnesisDeletedBy                  PatientAnamnesis[]         @relation("AnamnesisDeletedBy")
  AnamnesisLastVerifiedBy             PatientAnamnesis[]         @relation("AnamnesisLastVerifiedBy")
  AnamnesisReviewedBy                 AnamnesisAuditLog[]        @relation("AnamnesisReviewedBy")
  AnamnesisPendingReviewCreatedBy     AnamnesisPendingReview[]   @relation("AnamnesisPendingReviewCreatedBy")
  AnamnesisPendingReviewReviewedBy    AnamnesisPendingReview[]   @relation("AnamnesisPendingReviewReviewedBy")

  @@index([rolId])
  @@map("Usuario")
}

model Profesional {
  idProfesional  Int                       @id @default(autoincrement()) @map("idProfesional")
  numeroLicencia String?                   @unique @map("numeroLicencia")
  estaActivo     Boolean                   @default(true) @map("estaActivo")
  userId         Int                       @unique @map("Usuario_idUsuario")
  personaId      Int                       @unique @map("Persona_idPersona")
  createdAt      DateTime                  @default(now()) @map("created_at")
  disponibilidad Json?                     @map("disponibilidad")
  updatedAt      DateTime                  @updatedAt @map("updated_at")
  persona        Persona                   @relation(fields: [personaId], references: [idPersona])
  usuario        Usuario                   @relation(fields: [userId], references: [idUsuario], onDelete: Cascade)
  especialidades ProfesionalEspecialidad[]
  Cita           Cita[]
  BloqueoAgenda  BloqueoAgenda[]
  Consulta       Consulta[]

  @@index([estaActivo])
  @@map("Profesional")
}

model Persona {
  idPersona                  Int                   @id @default(autoincrement()) @map("idPersona")
  nombres                    String                @map("nombres")
  apellidos                  String                @map("apellidos")
  segundoApellido            String?               @map("segundo_apellido") // ‚≠ê Added for second last name
  fechaNacimiento            DateTime?             @map("fecha_nacimiento")
  genero                     Genero?               @map("genero")
  direccion                  String?               @map("direccion")
  ciudad                     String?               @map("ciudad") // ‚≠ê Added for city separation
  pais                       String?               @default("PY") @map("pais") // ‚≠ê Added for country separation (default Paraguay)
  // Emergency Contact Information
  contactoEmergenciaNombre   String?               @map("contacto_emergencia_nombre") // ‚≠ê Added for emergency contact
  contactoEmergenciaTelefono String?               @map("contacto_emergencia_telefono") // ‚≠ê Added for emergency contact
  contactoEmergenciaRelacion String?               @map("contacto_emergencia_relacion") // ‚≠ê Added for emergency contact relationship
  estaActivo                 Boolean               @default(true) @map("esta_activo")
  createdAt                  DateTime              @default(now()) @map("created_at")
  updatedAt                  DateTime              @updatedAt @map("updated_at")
  documento                  Documento?
  contactos                  PersonaContacto[]
  profesionales              Profesional?
  paciente                   Paciente?
  PacienteResponsable        PacienteResponsable[]
  consentimientosResponsable Consentimiento[]      @relation("ConsentimientoResponsable")
  consentimientos            Consentimiento[]

  @@index([nombres, apellidos])
  @@map("Persona")
}

model Documento {
  idDocumento      Int           @id @default(autoincrement()) @map("idDocumento")
  personaId        Int           @unique @map("Persona_idPersona")
  tipo             TipoDocumento @map("tipo")
  numero           String        @map("numero")
  paisEmision      String?       @map("pais_emision")
  fechaEmision     DateTime?     @map("fecha_emision")
  fechaVencimiento DateTime?     @map("fecha_vencimiento")
  ruc              String?       @map("ruc")
  persona          Persona       @relation(fields: [personaId], references: [idPersona], onDelete: Cascade)

  @@unique([tipo, numero, paisEmision])
  @@map("Documento")
}

model PersonaContacto {
  idContacto              Int          @id @default(autoincrement()) @map("idContacto")
  personaId               Int          @map("Persona_idPersona")
  tipo                    TipoContacto @map("tipo")
  valorRaw                String       @map("valor_raw")
  valorNorm               String       @map("valor_norm")
  label                   String?      @map("label")
  whatsappCapaz           Boolean?     @map("whatsapp_capaz")
  smsCapaz                Boolean?     @map("sms_capaz")
  esPrincipal             Boolean      @default(false) @map("es_principal")
  esPreferidoRecordatorio Boolean      @default(false) @map("es_pref_recordatorio")
  esPreferidoCobranza     Boolean      @default(false) @map("es_pref_cobranza")
  activo                  Boolean      @default(true) @map("activo")
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")

  persona Persona @relation(fields: [personaId], references: [idPersona], onDelete: Cascade)

  // üî• CLAVE √öNICA COMPUESTA que tu seed usa en el upsert:
  @@unique([personaId, tipo, valorNorm], name: "personaId_tipo_valorNorm")
  // ‚úÖ √≠ndices √∫tiles (opcional)
  @@index([personaId])
  @@index([tipo])
  @@index([valorNorm])
}

model Especialidad {
  idEspecialidad Int                       @id @default(autoincrement()) @map("idEspecialidad")
  nombre         String                    @unique @map("nombre")
  descripcion    String?                   @map("descripcion")
  isActive       Boolean                   @default(true) @map("is_active")
  createdAt      DateTime                  @default(now()) @map("created_at")
  updatedAt      DateTime                  @updatedAt @map("updated_at")
  profesionales  ProfesionalEspecialidad[]

  @@index([isActive])
  @@map("Especialidad")
}

model ProfesionalEspecialidad {
  profesionalId  Int
  especialidadId Int
  especialidad   Especialidad @relation(fields: [especialidadId], references: [idEspecialidad])
  profesional    Profesional  @relation(fields: [profesionalId], references: [idProfesional], onDelete: Cascade)

  @@id([profesionalId, especialidadId])
  @@map("ProfesionalEspecialidad")
}

enum RolNombre {
  ADMIN
  ODONT
  RECEP
}

enum Genero {
  MASCULINO
  FEMENINO
  OTRO
  NO_ESPECIFICADO
}

enum TipoDocumento {
  CI
  DNI
  PASAPORTE
  RUC
  OTRO
}

enum TipoContacto {
  PHONE
  EMAIL
}

enum RelacionPaciente {
  PADRE
  MADRE
  TUTOR
  CONYUGE
  FAMILIAR
  HIJO
  EMPRESA
  OTRO
}

enum TipoCita {
  CONSULTA
  LIMPIEZA
  ENDODONCIA
  EXTRACCION
  URGENCIA
  ORTODONCIA
  CONTROL
  OTRO
}

enum EstadoCita {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ======== MODELOS ========

// Paciente
model Paciente {
  idPaciente           Int      @id @default(autoincrement()) @map("idPaciente")
  personaId            Int      @unique @map("Persona_idPersona")
  notasAdministrativas String?  @map("notas_administrativas") // ‚ö†Ô∏è SOLO notas administrativas (ej: preferencias de horario), NO informaci√≥n cl√≠nica. Info cl√≠nica ‚Üí PatientAnamnesis
  estaActivo           Boolean  @default(true) @map("esta_activo")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  persona                 Persona                   @relation(fields: [personaId], references: [idPersona])
  responsables            PacienteResponsable[]
  citas                   Cita[] // <‚Äî importante: relaci√≥n inversa (solo lectura)
  TreatmentPlan           TreatmentPlan[]
  ClinicalHistoryEntry    ClinicalHistoryEntry[]
  PatientDiagnosis        PatientDiagnosis[]
  PatientAllergy          PatientAllergy[]
  PatientMedication       PatientMedication[]
  PatientVitals           PatientVitals[]
  OdontogramSnapshot      OdontogramSnapshot[]
  PeriodontogramSnapshot  PeriodontogramSnapshot[]
  Adjunto                 Adjunto[]
  consentimientos         Consentimiento[]
  anamnesisActual         PatientAnamnesis?
  anamnesisHistorial      PatientAnamnesisVersion[]
  anamnesisAuditLogs      AnamnesisAuditLog[]
  anamnesisPendingReviews AnamnesisPendingReview[]

  @@map("Paciente")
}

// Responsable de pago / tutor
model PacienteResponsable {
  idPacienteResponsable Int              @id @default(autoincrement()) @map("idPacienteResponsable")
  pacienteId            Int              @map("Paciente_idPaciente")
  personaId             Int              @map("Persona_idPersona")
  relacion              RelacionPaciente @map("relacion")
  esPrincipal           Boolean          @default(false) @map("es_principal")
  autoridadLegal        Boolean          @default(false) @map("autoridad_legal")
  vigenteDesde          DateTime         @default(now()) @map("vigente_desde")
  vigenteHasta          DateTime?        @map("vigente_hasta")
  notas                 String?          @map("notas")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  paciente Paciente @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  persona  Persona  @relation(fields: [personaId], references: [idPersona])

  @@index([pacienteId, personaId])
  @@map("PacienteResponsable")
}

// Consultorio / Box
model Consultorio {
  idConsultorio Int      @id @default(autoincrement()) @map("idConsultorio")
  nombre        String   @unique @map("nombre")
  colorHex      String?  @map("color_hex")
  activo        Boolean  @default(true) @map("activo")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  citas         Cita[]
  BloqueoAgenda BloqueoAgenda[]

  @@map("Consultorio")
}

// Cita / Turno
model Cita {
  idCita Int @id @default(autoincrement()) @map("idCita")

  // FKs
  pacienteId      Int  @map("Paciente_idPaciente")
  profesionalId   Int  @map("Profesional_idProfesional")
  consultorioId   Int? @map("Consultorio_idConsultorio")
  createdByUserId Int  @map("Usuario_idUsuario_createdBy")

  // Ventana y clasificaci√≥n
  inicio          DateTime   @map("inicio")
  fin             DateTime   @map("fin")
  duracionMinutos Int        @default(30) @map("duracion_minutos")
  tipo            TipoCita   @map("tipo")
  estado          EstadoCita @default(SCHEDULED) @map("estado")

  // Descripci√≥n (ADMINISTRATIVA, no cl√≠nica)
  motivo String? @map("motivo") // ‚ö†Ô∏è Motivo administrativo de agendamiento (ej: "Llam√≥ por dolor"), NO es el motivo cl√≠nico detallado. Motivo cl√≠nico ‚Üí PatientAnamnesis.motivoConsulta
  notas  String? @map("notas") // ‚ö†Ô∏è Notas administrativas de la cita (ej: "Reprogramar si llueve"), NO es informaci√≥n cl√≠nica

  // Reprogramaciones (self-relation)
  reprogramadaDesdeId Int?   @map("Cita_idCita_reprog_desde")
  reprogramadaDesde   Cita?  @relation("CitaReprogramacion", fields: [reprogramadaDesdeId], references: [idCita])
  reprogramaciones    Cita[] @relation("CitaReprogramacion")

  // Timestamps de flujo (√∫tiles para reporting)
  checkedInAt DateTime? @map("checked_in_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Cancelaci√≥n (qui√©n, cu√°ndo, por qu√©)
  cancelReason      MotivoCancelacion? @map("cancel_reason")
  cancelledAt       DateTime?          @map("cancelled_at")
  cancelledByUserId Int?               @map("Usuario_idUsuario_cancelledBy")

  // Metadatos/Extensi√≥n (opcional)
  metadatos Json? @map("metadatos")

  // Auditor√≠a
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  paciente    Paciente     @relation(fields: [pacienteId], references: [idPaciente])
  profesional Profesional  @relation(fields: [profesionalId], references: [idProfesional])
  consultorio Consultorio? @relation(fields: [consultorioId], references: [idConsultorio])

  // Importante: hay 2 relaciones a Usuario, por eso nombramos ambas
  creadoPor           Usuario               @relation("CitaCreadaPor", fields: [createdByUserId], references: [idUsuario])
  canceladoPor        Usuario?              @relation("CitaCanceladaPor", fields: [cancelledByUserId], references: [idUsuario])
  CitaEstadoHistorial CitaEstadoHistorial[]
  Consulta            Consulta[]
  consentimientos     Consentimiento[]

  // √çndices
  @@index([profesionalId, inicio])
  @@index([pacienteId, inicio])
  @@index([consultorioId, inicio])
  @@index([estado, inicio])
  @@index([inicio]) // acelerador para ventanas por fecha
  @@map("Cita")
}

enum MotivoCancelacion {
  PACIENTE
  PROFESIONAL
  CLINICA
  EMERGENCIA
  OTRO
}

enum TipoBloqueoAgenda {
  VACACIONES
  MANTENIMIENTO
  CAPACITACION
  BLOQUEO_MANUAL
  OTRO
}

model CitaEstadoHistorial {
  idCitaEstadoHistorial Int         @id @default(autoincrement()) @map("idCitaEstadoHistorial")
  citaId                Int         @map("Cita_idCita")
  estadoPrevio          EstadoCita? @map("estado_previo")
  estadoNuevo           EstadoCita  @map("estado_nuevo")
  nota                  String?     @map("nota")
  changedByUserId       Int?        @map("Usuario_idUsuario_changedBy")
  changedAt             DateTime    @default(now()) @map("changed_at")

  cita        Cita     @relation(fields: [citaId], references: [idCita], onDelete: Cascade)
  cambiadoPor Usuario? @relation(fields: [changedByUserId], references: [idUsuario])

  @@index([citaId, changedAt])
  @@index([estadoNuevo, changedAt])
  @@map("CitaEstadoHistorial")
}

model BloqueoAgenda {
  idBloqueoAgenda Int               @id @default(autoincrement()) @map("idBloqueoAgenda")
  profesionalId   Int?              @map("Profesional_idProfesional")
  consultorioId   Int?              @map("Consultorio_idConsultorio")
  desde           DateTime          @map("desde")
  hasta           DateTime          @map("hasta")
  tipo            TipoBloqueoAgenda @map("tipo")
  motivo          String?           @map("motivo")
  recurrencia     Json?             @map("recurrencia") // RRule u otro
  activo          Boolean           @default(true) @map("activo")

  createdByUserId Int      @map("Usuario_idUsuario_createdBy")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  profesional Profesional? @relation(fields: [profesionalId], references: [idProfesional])
  consultorio Consultorio? @relation(fields: [consultorioId], references: [idConsultorio])
  creadoPor   Usuario      @relation(fields: [createdByUserId], references: [idUsuario])

  @@index([profesionalId, desde])
  @@index([consultorioId, desde])
  @@index([activo, desde])
  @@map("BloqueoAgenda")
}

enum ConsultaEstado {
  DRAFT
  FINAL
}

enum DienteSuperficie {
  O // Oclusal
  M // Mesial
  D // Distal
  V // Vestibular/Bucal
  L // Lingual/Palatino
  MO
  DO
  VO
  LO
  MOD
  MV
  DL
  // agrega combinaciones que uses en cl√≠nica
}

enum AdjuntoTipo {
  XRAY
  INTRAORAL_PHOTO
  EXTRAORAL_PHOTO
  IMAGE
  DOCUMENT
  PDF
  LAB_REPORT
  OTHER
}

enum AccessMode {
  PUBLIC
  AUTHENTICATED
}

enum TreatmentStepStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

enum TreatmentPlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model ProcedimientoCatalogo {
  idProcedimiento    Int      @id @default(autoincrement()) @map("idProcedimiento")
  code               String   @unique @map("code") // p.ej. C11, ADA code, interno, etc.
  nombre             String   @map("nombre")
  descripcion        String?  @map("descripcion")
  defaultDurationMin Int?     @map("default_duration_min")
  defaultPriceCents  Int?     @map("default_price_cents")
  aplicaDiente       Boolean  @default(false) @map("aplica_diente")
  aplicaSuperficie   Boolean  @default(false) @map("aplica_superficie")
  esCirugia          Boolean  @default(false) @map("es_cirugia")
  activo             Boolean  @default(true) @map("activo")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relaciones
  pasos                    TreatmentStep[]
  procedimientos           ConsultaProcedimiento[]
  TreatmentPlanCatalogStep TreatmentPlanCatalogStep[]

  @@map("ProcedimientoCatalogo")
}

model Consulta {
  // PK=FK a Cita (1:1)
  citaId Int  @id @map("Cita_idCita")
  cita   Cita @relation(fields: [citaId], references: [idCita], onDelete: Cascade)

  performedById Int         @map("Profesional_idProfesional")
  performedBy   Profesional @relation(fields: [performedById], references: [idProfesional])

  status     ConsultaEstado @default(DRAFT) @map("status")
  startedAt  DateTime?      @map("started_at")
  finishedAt DateTime?      @map("finished_at")

  // ‚ö†Ô∏è DEPRECADO: reason eliminado. El motivo cl√≠nico debe obtenerse de:
  // - paciente.anamnesisActual.motivoConsulta (estado actual)
  // - PatientAnamnesisVersion vinculada a esta consulta (hist√≥rico)
  // reason        String? @map("reason") // ‚ùå ELIMINADO - usar PatientAnamnesis.motivoConsulta

  diagnosis     String? @map("diagnosis") // ‚úÖ Diagn√≥stico de la consulta (resultado), diferente del motivo
  clinicalNotes String? @map("clinical_notes") // ‚úÖ Notas del profesional durante/despu√©s de la consulta, complementarias a anamnesis (anamnesis = estado paciente, clinicalNotes = observaciones profesional)

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Hijos
  procedimientos         ConsultaProcedimiento[]
  adjuntos               Adjunto[]
  ClinicalHistoryEntry   ClinicalHistoryEntry[]
  PatientDiagnosis       PatientDiagnosis[]
  PatientVitals          PatientVitals[]
  OdontogramSnapshot     OdontogramSnapshot[]
  PeriodontogramSnapshot PeriodontogramSnapshot[]
  anamnesisVersiones     PatientAnamnesisVersion[]
  anamnesisAuditLogs     AnamnesisAuditLog[]
  encounterDiagnoses     EncounterDiagnosis[]
  diagnosisStatusHistory DiagnosisStatusHistory[]
  patientMedications     PatientMedication[]

  @@map("Consulta")
}

model ConsultaProcedimiento {
  idConsultaProcedimiento Int @id @default(autoincrement()) @map("idConsultaProcedimiento")

  consultaId Int      @map("Consulta_Cita_idCita")
  consulta   Consulta @relation(fields: [consultaId], references: [citaId], onDelete: Cascade)

  // Definici√≥n del acto: cat√°logo o texto libre (elige uno; ver CHECK m√°s abajo)
  procedureId Int?                   @map("Procedimiento_idProcedimiento")
  catalogo    ProcedimientoCatalogo? @relation(fields: [procedureId], references: [idProcedimiento], onDelete: SetNull)
  serviceType String?                @map("service_type")

  // Diente / superficie (opcionales seg√∫n el procedimiento)
  toothNumber  Int?              @map("tooth_number") // 1‚Äì32 / 51‚Äì85
  toothSurface DienteSuperficie? @map("tooth_surface")

  // Cantidad y costos aplicados
  quantity       Int  @default(1) @map("quantity")
  unitPriceCents Int? @map("unit_price_cents")
  totalCents     Int? @map("total_cents")

  // V√≠nculo con planificaci√≥n (si ejecuta una etapa)
  treatmentStepId Int?           @map("TreatmentStep_idTreatmentStep")
  treatmentStep   TreatmentStep? @relation(fields: [treatmentStepId], references: [idTreatmentStep], onDelete: SetNull)

  // V√≠nculo con diagn√≥stico (opcional)
  diagnosisId Int?              @map("PatientDiagnosis_idPatientDiagnosis")
  diagnosis   PatientDiagnosis? @relation(fields: [diagnosisId], references: [idPatientDiagnosis], onDelete: SetNull)

  resultNotes String? @map("result_notes")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  ConsultaAdjunto Adjunto[]

  @@index([consultaId])
  @@index([procedureId])
  @@index([treatmentStepId])
  @@index([diagnosisId])
  @@map("ConsultaProcedimiento")
}

model Adjunto {
  idAdjunto Int @id @default(autoincrement()) @map("idAdjunto")

  // ==== V√≠nculos cl√≠nicos (opcionales) ====
  pacienteId      Int? @map("Paciente_idPaciente")
  consultaId      Int? @map("Consulta_Cita_idCita")
  procedimientoId Int? @map("ConsultaProcedimiento_idConsultaProcedimiento")

  paciente      Paciente?              @relation(fields: [pacienteId], references: [idPaciente], onDelete: SetNull)
  consulta      Consulta?              @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)
  procedimiento ConsultaProcedimiento? @relation(fields: [procedimientoId], references: [idConsultaProcedimiento], onDelete: SetNull)

  // ==== Clasificaci√≥n cl√≠nica ====
  tipo        AdjuntoTipo @map("tipo")
  descripcion String?     @map("descripcion") @db.VarChar(500)

  // ==== Cloudinary / storage ====
  // Clave primaria en storage (lo √∫nico realmente necesario para re-hidratar la URL):
  publicId         String     @unique @map("public_id")
  folder           String     @map("folder")
  resourceType     String     @map("resource_type") // "image" | "video" | "raw"
  format           String?    @map("format")
  bytes            Int        @map("bytes")
  width            Int?       @map("width")
  height           Int?       @map("height")
  duration         Float?     @map("duration")
  originalFilename String?    @map("original_filename")
  accessMode       AccessMode @default(AUTHENTICATED) @map("access_mode")

  // Campo derivable: podr√≠as NO persistir la URL; la regeneras firmada cuando la serv√≠s.
  // Si quieres cachearla para thumbnails o auditor√≠a, manten√© secureUrl:
  secureUrl String @map("secure_url")

  // ==== Seguridad/borrado l√≥gico ====
  isActive        Boolean   @default(true) @map("is_active")
  deletedAt       DateTime? @map("deleted_at")
  deletedByUserId Int?      @map("Usuario_idUsuario_deletedBy")
  deletedBy       Usuario?  @relation(fields: [deletedByUserId], references: [idUsuario])

  // ==== Auditor√≠a ====
  uploadedByUserId Int     @map("Usuario_idUsuario_uploadedBy")
  uploadedBy       Usuario @relation("AdjuntoUploadedBy", fields: [uploadedByUserId], references: [idUsuario])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ==== √çndices ====
  @@index([pacienteId, createdAt])
  @@index([consultaId, createdAt])
  @@index([procedimientoId, createdAt])
  @@index([tipo, createdAt])
  @@index([accessMode, createdAt])
  @@map("Adjunto")
}

model TreatmentPlan {
  idTreatmentPlan Int      @id @default(autoincrement()) @map("idTreatmentPlan")
  pacienteId      Int      @map("Paciente_idPaciente")
  paciente        Paciente @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)

  titulo      String              @map("titulo")
  descripcion String?             @map("descripcion")
  status      TreatmentPlanStatus @default(ACTIVE) @map("status")

  // Optional reference to catalog plan (for tracking)
  catalogPlanId Int?                  @map("TreatmentPlanCatalog_idTreatmentPlanCatalog")
  catalogPlan   TreatmentPlanCatalog? @relation(fields: [catalogPlanId], references: [idTreatmentPlanCatalog], onDelete: SetNull)

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  creadoPor       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  steps TreatmentStep[]

  @@index([pacienteId, status])
  @@index([catalogPlanId])
  @@map("TreatmentPlan")
}

model TreatmentStep {
  idTreatmentStep Int           @id @default(autoincrement()) @map("idTreatmentStep")
  treatmentPlanId Int           @map("TreatmentPlan_idTreatmentPlan")
  plan            TreatmentPlan @relation(fields: [treatmentPlanId], references: [idTreatmentPlan], onDelete: Cascade)

  order Int @map("order")

  // Definici√≥n cl√≠nica (elige cat√°logo o texto libre)
  procedureId           Int?                   @map("Procedimiento_idProcedimiento")
  procedimientoCatalogo ProcedimientoCatalogo? @relation(fields: [procedureId], references: [idProcedimiento], onDelete: SetNull)
  serviceType           String?                @map("service_type")

  toothNumber  Int?              @map("tooth_number")
  toothSurface DienteSuperficie? @map("tooth_surface")

  estimatedDurationMin Int?                @map("estimated_duration_min")
  estimatedCostCents   Int?                @map("estimated_cost_cents")
  priority             Int?                @map("priority") // 1..5
  status               TreatmentStepStatus @default(PENDING) @map("status")
  notes                String?             @map("notes")

  // Multi-session support
  requiresMultipleSessions Boolean   @default(false) @map("requires_multiple_sessions")
  totalSessions            Int?      @map("total_sessions")
  currentSession           Int?      @default(1) @map("current_session")
  completedAt              DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Ejecuci√≥n cl√≠nica (l√≠neas realizadas que cumplen este step)
  consultaProcedimientos ConsultaProcedimiento[]

  @@unique([treatmentPlanId, order])
  @@index([status])
  @@map("TreatmentStep")
}

// ============== Cat√°logo de Planes de Tratamiento ==============

model TreatmentPlanCatalog {
  idTreatmentPlanCatalog Int      @id @default(autoincrement()) @map("idTreatmentPlanCatalog")
  code                   String   @unique @map("code")
  nombre                 String   @map("nombre")
  descripcion            String?  @map("descripcion")
  isActive               Boolean  @default(true) @map("is_active")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  steps          TreatmentPlanCatalogStep[]
  treatmentPlans TreatmentPlan[]

  @@map("TreatmentPlanCatalog")
}

model TreatmentPlanCatalogStep {
  idTreatmentPlanCatalogStep Int                  @id @default(autoincrement()) @map("idTreatmentPlanCatalogStep")
  catalogPlanId              Int                  @map("TreatmentPlanCatalog_idTreatmentPlanCatalog")
  catalogPlan                TreatmentPlanCatalog @relation(fields: [catalogPlanId], references: [idTreatmentPlanCatalog], onDelete: Cascade)

  order Int @map("order")

  // Definici√≥n cl√≠nica (elige cat√°logo o texto libre)
  procedureId           Int?                   @map("Procedimiento_idProcedimiento")
  procedimientoCatalogo ProcedimientoCatalogo? @relation(fields: [procedureId], references: [idProcedimiento], onDelete: SetNull)
  serviceType           String?                @map("service_type")

  toothNumber  Int?              @map("tooth_number")
  toothSurface DienteSuperficie? @map("tooth_surface")

  estimatedDurationMin Int?    @map("estimated_duration_min")
  estimatedCostCents   Int?    @map("estimated_cost_cents")
  priority             Int?    @map("priority") // 1..5
  notes                String? @map("notes")

  // Multi-session support
  requiresMultipleSessions Boolean @default(false) @map("requires_multiple_sessions")
  totalSessions            Int?    @map("total_sessions")
  currentSession           Int?    @default(1) @map("current_session")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([catalogPlanId, order])
  @@map("TreatmentPlanCatalogStep")
}

// ============== 1) Historia cl√≠nica general =================
model ClinicalHistoryEntry {
  idClinicalHistoryEntry Int      @id @default(autoincrement()) @map("idClinicalHistoryEntry")
  pacienteId             Int      @map("Paciente_idPaciente")
  consultaId             Int?     @map("Consulta_Cita_idCita") // vers. hist√≥rica por cita (opcional)
  fecha                  DateTime @default(now()) @map("fecha")
  title                  String?  @map("title")
  notes                  String   @map("notes")

  createdByUserId Int      @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario  @relation(fields: [createdByUserId], references: [idUsuario])
  createdAt       DateTime @default(now()) @map("created_at")

  paciente Paciente  @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  consulta Consulta? @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)

  @@index([pacienteId, fecha])
  @@index([consultaId])
  @@map("ClinicalHistoryEntry")
}

// ============== 2) Diagn√≥sticos ==============================

enum DiagnosisStatus {
  ACTIVE
  UNDER_FOLLOW_UP
  RESOLVED
  DISCARDED
  RULED_OUT // Keep for backward compatibility
}

model DiagnosisCatalog {
  idDiagnosisCatalog Int      @id @default(autoincrement()) @map("idDiagnosisCatalog")
  code               String   @unique @map("code") // CIE-10 o c√≥digo interno
  name               String   @map("name")
  description        String?  @map("description")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  patientDiagnoses PatientDiagnosis[]

  @@map("DiagnosisCatalog")
}

model PatientDiagnosis {
  idPatientDiagnosis Int               @id @default(autoincrement()) @map("idPatientDiagnosis")
  pacienteId         Int               @map("Paciente_idPaciente")
  diagnosisId        Int?              @map("DiagnosisCatalog_id")
  diagnosisCatalog   DiagnosisCatalog? @relation(fields: [diagnosisId], references: [idDiagnosisCatalog], onDelete: SetNull)

  // si no us√°s cat√°logo: libre
  code  String? @map("code")
  label String  @map("label")

  status     DiagnosisStatus @default(ACTIVE) @map("status")
  notedAt    DateTime        @default(now()) @map("noted_at")
  resolvedAt DateTime?       @map("resolved_at")
  notes      String?         @map("notes")

  // qui√©n y d√≥nde se registr√≥
  consultaId      Int?      @map("Consulta_Cita_idCita")
  createdByUserId Int       @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario   @relation(fields: [createdByUserId], references: [idUsuario])
  consulta        Consulta? @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)

  paciente Paciente @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)

  // Relaciones nuevas
  encounterDiagnoses     EncounterDiagnosis[]
  consultaProcedimientos ConsultaProcedimiento[]
  statusHistory          DiagnosisStatusHistory[]

  @@index([pacienteId, status, notedAt])
  @@index([consultaId])
  @@map("PatientDiagnosis")
}

// Encounter-Diagnosis junction table for tracking diagnosis evaluation per encounter
model EncounterDiagnosis {
  idEncounterDiagnosis Int @id @default(autoincrement()) @map("idEncounterDiagnosis")
  consultaId           Int @map("Consulta_Cita_idCita")
  diagnosisId          Int @map("PatientDiagnosis_idPatientDiagnosis")

  // Encounter-specific context
  encounterNotes String? @map("encounter_notes") @db.VarChar(1000)
  wasEvaluated   Boolean @default(true) @map("was_evaluated")
  wasManaged     Boolean @default(false) @map("was_managed")

  consulta  Consulta         @relation(fields: [consultaId], references: [citaId], onDelete: Cascade)
  diagnosis PatientDiagnosis @relation(fields: [diagnosisId], references: [idPatientDiagnosis], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([consultaId, diagnosisId])
  @@index([consultaId])
  @@index([diagnosisId])
  @@map("EncounterDiagnosis")
}

// Audit trail for diagnosis status changes
model DiagnosisStatusHistory {
  idDiagnosisStatusHistory Int  @id @default(autoincrement()) @map("idDiagnosisStatusHistory")
  diagnosisId              Int  @map("PatientDiagnosis_idPatientDiagnosis")
  consultaId               Int? @map("Consulta_Cita_idCita")

  previousStatus DiagnosisStatus? @map("previous_status")
  newStatus      DiagnosisStatus  @map("new_status")
  reason         String?          @map("reason") @db.VarChar(500)

  changedByUserId Int      @map("Usuario_idUsuario_changedBy")
  changedAt       DateTime @default(now()) @map("changed_at")

  diagnosis PatientDiagnosis @relation(fields: [diagnosisId], references: [idPatientDiagnosis], onDelete: Cascade)
  consulta  Consulta?        @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)
  changedBy Usuario          @relation("DiagnosisStatusHistoryChangedBy", fields: [changedByUserId], references: [idUsuario])

  @@index([diagnosisId, changedAt])
  @@index([consultaId])
  @@map("DiagnosisStatusHistory")
}

// ============== 3) Alergias y medicaci√≥n =====================

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
}

model AllergyCatalog {
  idAllergyCatalog Int      @id @default(autoincrement()) @map("idAllergyCatalog")
  name             String   @unique @map("name")
  description      String?  @map("description")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  patientAllergies PatientAllergy[]

  @@map("AllergyCatalog")
}

model PatientAllergy {
  idPatientAllergy Int             @id @default(autoincrement()) @map("idPatientAllergy")
  pacienteId       Int             @map("Paciente_idPaciente")
  allergyId        Int?            @map("AllergyCatalog_id")
  allergyCatalog   AllergyCatalog? @relation(fields: [allergyId], references: [idAllergyCatalog], onDelete: SetNull)

  // libre si no cat
  label    String?         @map("label")
  severity AllergySeverity @default(MODERATE) @map("severity")
  reaction String?         @map("reaction")
  notedAt  DateTime        @default(now()) @map("noted_at")
  isActive Boolean         @default(true) @map("is_active")

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  paciente           Paciente           @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  anamnesisAllergies AnamnesisAllergy[]

  @@index([pacienteId, isActive])
  @@map("PatientAllergy")
}

model MedicationCatalog {
  idMedicationCatalog Int      @id @default(autoincrement()) @map("idMedicationCatalog")
  name                String   @unique @map("name")
  description         String?  @map("description")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  patientMedications PatientMedication[]

  @@map("MedicationCatalog")
}

model PatientMedication {
  idPatientMedication Int                @id @default(autoincrement()) @map("idPatientMedication")
  pacienteId          Int                @map("Paciente_idPaciente")
  medicationId        Int?               @map("MedicationCatalog_id")
  medicationCatalog   MedicationCatalog? @relation(fields: [medicationId], references: [idMedicationCatalog], onDelete: SetNull)

  // libre si no cat
  label       String?   @map("label")
  description String?   @map("description") @db.VarChar(1000)
  dose        String?   @map("dose")
  freq        String?   @map("freq")
  route       String?   @map("route")
  startAt     DateTime? @map("start_at")
  endAt       DateTime? @map("end_at")
  isActive    Boolean   @default(true) @map("is_active")

  // Audit fields
  updatedAt            DateTime? @updatedAt @map("updated_at")
  updatedByUserId      Int?      @map("Usuario_idUsuario_updatedBy")
  updatedBy            Usuario?  @relation("PatientMedicationUpdatedBy", fields: [updatedByUserId], references: [idUsuario])
  discontinuedAt       DateTime? @map("discontinued_at")
  discontinuedByUserId Int?      @map("Usuario_idUsuario_discontinuedBy")
  discontinuedBy       Usuario?  @relation("PatientMedicationDiscontinuedBy", fields: [discontinuedByUserId], references: [idUsuario])
  consultaId           Int?      @map("Consulta_Cita_idCita")
  consulta             Consulta? @relation(fields: [consultaId], references: [citaId])

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation("PatientMedicationCreatedBy", fields: [createdByUserId], references: [idUsuario])

  paciente             Paciente              @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  anamnesisMedications AnamnesisMedication[]

  @@index([pacienteId, isActive])
  @@index([consultaId])
  @@map("PatientMedication")
}

// ============== 4) Vitales ==================================
model PatientVitals {
  idPatientVitals Int      @id @default(autoincrement()) @map("idPatientVitals")
  pacienteId      Int      @map("Paciente_idPaciente")
  consultaId      Int?     @map("Consulta_Cita_idCita")
  measuredAt      DateTime @default(now()) @map("measured_at")

  // Lo habitual en sill√≥n (agreg√° lo que uses)
  heightCm  Int?   @map("height_cm")
  weightKg  Int?   @map("weight_kg")
  bmi       Float? @map("bmi")
  bpSyst    Int?   @map("bp_syst")
  bpDiast   Int?   @map("bp_diast")
  heartRate Int?   @map("heart_rate")

  notes String? @map("notes")

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  paciente Paciente  @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  consulta Consulta? @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)

  @@index([pacienteId, measuredAt])
  @@index([consultaId])
  @@map("PatientVitals")
}

// ============== 5) Odontograma (versionable) =================

enum ToothCondition {
  INTACT
  CARIES
  FILLED
  MISSING
  ROOT_CANAL
  CROWN
  BRIDGE
  IMPLANT
  EXTRACTION_NEEDED
  FRACTURED
}

model OdontogramSnapshot {
  idOdontogramSnapshot Int      @id @default(autoincrement()) @map("idOdontogramSnapshot")
  pacienteId           Int      @map("Paciente_idPaciente")
  consultaId           Int?     @map("Consulta_Cita_idCita") // si es por cita (recomendado)
  takenAt              DateTime @default(now()) @map("taken_at")
  notes                String?  @map("notes")

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  paciente Paciente          @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  consulta Consulta?         @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)
  entries  OdontogramEntry[]

  @@index([pacienteId, takenAt])
  @@index([consultaId])
  @@map("OdontogramSnapshot")
}

model OdontogramEntry {
  idOdontogramEntry Int               @id @default(autoincrement()) @map("idOdontogramEntry")
  snapshotId        Int               @map("OdontogramSnapshot_id")
  toothNumber       Int               @map("tooth_number") // 1‚Äì32 / 51‚Äì85
  surface           DienteSuperficie? @map("surface")
  condition         ToothCondition    @default(INTACT) @map("condition")
  notes             String?           @map("notes")

  snapshot OdontogramSnapshot @relation(fields: [snapshotId], references: [idOdontogramSnapshot], onDelete: Cascade)

  @@unique([snapshotId, toothNumber, surface])
  @@index([toothNumber])
  @@map("OdontogramEntry")
}

// ============== 6) Periodontograma (opcional) ================

enum PerioBleeding {
  NONE
  YES
}

model PeriodontogramSnapshot {
  idPeriodontogramSnapshot Int      @id @default(autoincrement()) @map("idPeriodontogramSnapshot")
  pacienteId               Int      @map("Paciente_idPaciente")
  consultaId               Int?     @map("Consulta_Cita_idCita")
  takenAt                  DateTime @default(now()) @map("taken_at")
  notes                    String?  @map("notes")

  createdByUserId Int     @map("Usuario_idUsuario_createdBy")
  createdBy       Usuario @relation(fields: [createdByUserId], references: [idUsuario])

  paciente Paciente                @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  consulta Consulta?               @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)
  measures PeriodontogramMeasure[]

  @@index([pacienteId, takenAt])
  @@index([consultaId])
  @@map("PeriodontogramSnapshot")
}

// Convenci√≥n de sitio periodontal (ejemplo): de 1..6 por diente (DB, B, MB, DL, L, ML) o define un enum
enum PerioSite {
  DB
  B
  MB
  DL
  L
  ML
}

model PeriodontogramMeasure {
  idPeriodontogramMeasure Int       @id @default(autoincrement()) @map("idPeriodontogramMeasure")
  snapshotId              Int       @map("PeriodontogramSnapshot_id")
  toothNumber             Int       @map("tooth_number")
  site                    PerioSite @map("site")

  probingDepthMm Int?           @map("probing_depth_mm")
  bleeding       PerioBleeding? @map("bleeding")
  plaque         Boolean?       @map("plaque")
  mobility       Int?           @map("mobility") // 0..3
  furcation      Int?           @map("furcation") // 0..3

  snapshot PeriodontogramSnapshot @relation(fields: [snapshotId], references: [idPeriodontogramSnapshot], onDelete: Cascade)

  @@unique([snapshotId, toothNumber, site])
  @@index([toothNumber])
  @@map("PeriodontogramMeasure")
}

// ==========================
// Enum
// ==========================
enum TipoConsentimiento {
  CONSENTIMIENTO_MENOR_ATENCION
  TRATAMIENTO_ESPECIFICO
  ANESTESIA
  CIRUGIA
  RADIOGRAFIA
  DATOS_PERSONALES
  OTRO

  @@map("TipoConsentimiento")
}

enum AnamnesisTipo {
  ADULTO
  PEDIATRICO
}

enum AnamnesisAuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  RESTORE
  EXPORT
  PRINT
}

enum AnamnesisChangeSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum FieldChangeType {
  ADDED
  REMOVED
  MODIFIED
}

enum AnamnesisUrgencia {
  RUTINA
  PRIORITARIO
  URGENCIA
}

enum InformationSource {
  IN_PERSON
  PHONE
  EMAIL
  DOCUMENT
  PATIENT_PORTAL
  OTHER
}

enum AnamnesisStatus {
  VALID
  EXPIRED
  PENDING_REVIEW
  NO_ANAMNESIS
}

enum AntecedentCategory {
  CARDIOVASCULAR
  ENDOCRINE
  RESPIRATORY
  GASTROINTESTINAL
  NEUROLOGICAL
  SURGICAL_HISTORY
  SMOKING
  ALCOHOL
  OTHER
}

// ==========================
// Modelo
// ==========================
model Consentimiento {
  // PK
  idConsentimiento Int @id @default(autoincrement()) @map("idConsentimiento")

  // FKs
  Paciente_idPaciente             Int  @map("Paciente_idPaciente")
  Persona_idPersona_responsable   Int  @map("Persona_idPersona_responsable")
  Cita_idCita                     Int? @map("Cita_idCita")
  Usuario_idUsuario_registradoPor Int  @map("Usuario_idUsuario_registradoPor")

  // Relaciones
  paciente      Paciente @relation(fields: [Paciente_idPaciente], references: [idPaciente], onDelete: Cascade, onUpdate: Cascade)
  responsable   Persona  @relation(fields: [Persona_idPersona_responsable], references: [idPersona], onDelete: Restrict, onUpdate: Cascade)
  cita          Cita?    @relation(fields: [Cita_idCita], references: [idCita], onDelete: SetNull, onUpdate: Cascade)
  registradoPor Usuario  @relation(fields: [Usuario_idUsuario_registradoPor], references: [idUsuario], onDelete: Restrict, onUpdate: Cascade)

  // Datos del consentimiento
  tipo          TipoConsentimiento @map("tipo")
  firmado_en    DateTime           @map("firmado_en")
  vigente_hasta DateTime           @map("vigente_hasta")
  registrado_en DateTime           @default(now()) @map("registrado_en")

  // Metadata del archivo (Cloudinary u otro)
  public_id  String  @unique @map("public_id")
  secure_url String  @map("secure_url")
  format     String? @map("format")
  bytes      Int     @map("bytes")
  width      Int?    @map("width")
  height     Int?    @map("height")
  hash       String? @map("hash")
  provider   String  @default("CLOUDINARY") @map("provider")

  // Otros
  observaciones       String? @map("observaciones")
  version             Int     @default(1) @map("version")
  activo              Boolean @default(true) @map("activo")
  esEspecificoPorCita Boolean @default(false) @map("es_especifico_por_cita")

  // Timestamps
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime  @updatedAt @map("updated_at")
  personas   Persona[] @relation("ConsentimientoResponsable")

  @@unique([Cita_idCita, tipo, activo], map: "unique_consent_per_cita_tipo")
  // √çndices para consultas comunes
  @@index([Paciente_idPaciente, tipo, activo], map: "Consentimiento_Paciente_idPaciente_tipo_activo_idx")
  @@index([Paciente_idPaciente, Persona_idPersona_responsable, tipo, activo], map: "Consentimiento_Paciente_idPaciente_Persona_idPersona_respo_idx")
  @@index([vigente_hasta], map: "Consentimiento_vigente_hasta_idx")
  @@index([Cita_idCita], map: "Consentimiento_Cita_idCita_idx")
  @@index([esEspecificoPorCita, Cita_idCita], map: "Consentimiento_esEspecificoPorCita_Cita_idx")
  @@map("Consentimiento")
}

// ============== 7) Anamnesis (versionable) =================

// Antecedent Catalog for normalized medical history
model AntecedentCatalog {
  idAntecedentCatalog Int                @id @default(autoincrement()) @map("idAntecedentCatalog")
  code                String             @unique @map("code") // e.g., "HYPERTENSION", "DIABETES"
  name                String             @map("name")
  category            AntecedentCategory @map("category")
  description         String?            @map("description")
  isActive            Boolean            @default(true) @map("is_active")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  antecedents AnamnesisAntecedent[]

  @@index([category])
  @@index([isActive])
  @@map("AntecedentCatalog")
}

// Medical antecedents linked to anamnesis
model AnamnesisAntecedent {
  idAnamnesisAntecedent Int                @id @default(autoincrement()) @map("idAnamnesisAntecedent")
  anamnesisId           Int                @map("PatientAnamnesis_id")
  antecedentId          Int?               @map("AntecedentCatalog_id")
  antecedentCatalog     AntecedentCatalog? @relation(fields: [antecedentId], references: [idAntecedentCatalog], onDelete: SetNull)

  // Custom antecedent (if not in catalog)
  customName     String?             @map("custom_name")
  customCategory AntecedentCategory? @map("custom_category")
  notes          String?             @map("notes")

  // Timing/status
  diagnosedAt DateTime? @map("diagnosed_at")
  isActive    Boolean   @default(true) @map("is_active")
  resolvedAt  DateTime? @map("resolved_at")

  anamnesis PatientAnamnesis @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)

  @@index([anamnesisId])
  @@index([antecedentId])
  @@index([isActive])
  @@map("AnamnesisAntecedent")
}

// Audit action enum for medication/allergy changes
enum AnamnesisMedicationAllergyAction {
  ADDED
  UPDATED
  DEACTIVATED
  REACTIVATED
  REMOVED
}

// Junction table linking anamnesis to medications
model AnamnesisMedication {
  idAnamnesisMedication Int               @id @default(autoincrement()) @map("idAnamnesisMedication")
  anamnesisId           Int               @map("PatientAnamnesis_id")
  medicationId          Int               @map("PatientMedication_id")
  anamnesis             PatientAnamnesis  @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)
  medication            PatientMedication @relation(fields: [medicationId], references: [idPatientMedication], onDelete: Cascade)

  // Metadata fields for tracking
  isActive        Boolean   @default(true) @map("is_active")
  addedAt         DateTime  @default(now()) @map("added_at")
  removedAt       DateTime? @map("removed_at")
  notes           String?   @map("notes")
  addedByUserId   Int       @map("Usuario_idUsuario_addedBy")
  removedByUserId Int?      @map("Usuario_idUsuario_removedBy")

  addedBy      Usuario                    @relation("AnamnesisMedicationAddedBy", fields: [addedByUserId], references: [idUsuario])
  removedBy    Usuario?                   @relation("AnamnesisMedicationRemovedBy", fields: [removedByUserId], references: [idUsuario])
  auditEntries AnamnesisMedicationAudit[]

  @@unique([anamnesisId, medicationId])
  @@index([anamnesisId])
  @@index([medicationId])
  @@index([anamnesisId, isActive])
  @@index([addedAt])
  @@map("AnamnesisMedication")
}

// Junction table linking anamnesis to allergies
model AnamnesisAllergy {
  idAnamnesisAllergy Int              @id @default(autoincrement()) @map("idAnamnesisAllergy")
  anamnesisId        Int              @map("PatientAnamnesis_id")
  allergyId          Int              @map("PatientAllergy_id")
  anamnesis          PatientAnamnesis @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)
  allergy            PatientAllergy   @relation(fields: [allergyId], references: [idPatientAllergy], onDelete: Cascade)

  // Metadata fields for tracking
  isActive        Boolean   @default(true) @map("is_active")
  addedAt         DateTime  @default(now()) @map("added_at")
  removedAt       DateTime? @map("removed_at")
  notes           String?   @map("notes")
  addedByUserId   Int       @map("Usuario_idUsuario_addedBy")
  removedByUserId Int?      @map("Usuario_idUsuario_removedBy")

  addedBy      Usuario                 @relation("AnamnesisAllergyAddedBy", fields: [addedByUserId], references: [idUsuario])
  removedBy    Usuario?                @relation("AnamnesisAllergyRemovedBy", fields: [removedByUserId], references: [idUsuario])
  auditEntries AnamnesisAllergyAudit[]

  @@unique([anamnesisId, allergyId])
  @@index([anamnesisId])
  @@index([allergyId])
  @@index([anamnesisId, isActive])
  @@index([addedAt])
  @@map("AnamnesisAllergy")
}

// Audit table for medication changes in anamnesis
model AnamnesisMedicationAudit {
  idAnamnesisMedicationAudit Int                              @id @default(autoincrement()) @map("idAnamnesisMedicationAudit")
  anamnesisMedicationId      Int                              @map("AnamnesisMedication_id")
  action                     AnamnesisMedicationAllergyAction @map("action")
  previousValue              Json?                            @map("previous_value") // Snapshot before change
  newValue                   Json?                            @map("new_value") // Snapshot after change
  performedAt                DateTime                         @default(now()) @map("performed_at")
  performedByUserId          Int                              @map("Usuario_idUsuario_performedBy")
  notes                      String?                          @map("notes")

  anamnesisMedication AnamnesisMedication @relation(fields: [anamnesisMedicationId], references: [idAnamnesisMedication], onDelete: Cascade)
  performedBy         Usuario             @relation("AnamnesisMedicationAuditPerformedBy", fields: [performedByUserId], references: [idUsuario])

  @@index([anamnesisMedicationId])
  @@index([performedAt])
  @@index([action])
  @@map("AnamnesisMedicationAudit")
}

// Audit table for allergy changes in anamnesis
model AnamnesisAllergyAudit {
  idAnamnesisAllergyAudit Int                              @id @default(autoincrement()) @map("idAnamnesisAllergyAudit")
  anamnesisAllergyId      Int                              @map("AnamnesisAllergy_id")
  action                  AnamnesisMedicationAllergyAction @map("action")
  previousValue           Json?                            @map("previous_value") // Snapshot before change
  newValue                Json?                            @map("new_value") // Snapshot after change
  performedAt             DateTime                         @default(now()) @map("performed_at")
  performedByUserId       Int                              @map("Usuario_idUsuario_performedBy")
  notes                   String?                          @map("notes")

  anamnesisAllergy AnamnesisAllergy @relation(fields: [anamnesisAllergyId], references: [idAnamnesisAllergy], onDelete: Cascade)
  performedBy      Usuario          @relation("AnamnesisAllergyAuditPerformedBy", fields: [performedByUserId], references: [idUsuario])

  @@index([anamnesisAllergyId])
  @@index([performedAt])
  @@index([action])
  @@map("AnamnesisAllergyAudit")
}

// Configuration table for anamnesis rules
model AnamnesisConfig {
  idAnamnesisConfig Int      @id @default(autoincrement()) @map("idAnamnesisConfig")
  key               String   @unique @map("key") // e.g., "MANDATORY_FIRST_CONSULTATION", "ALLOW_EDIT_SUBSEQUENT"
  value             Json     @map("value") // Flexible config values
  description       String?  @map("description")
  updatedAt         DateTime @updatedAt @map("updated_at")
  updatedByUserId   Int      @map("Usuario_idUsuario_updatedBy")

  updatedBy Usuario @relation(fields: [updatedByUserId], references: [idUsuario])

  @@map("AnamnesisConfig")
}

model PatientAnamnesis {
  idPatientAnamnesis Int           @id @default(autoincrement()) @map("idPatientAnamnesis")
  pacienteId         Int           @unique @map("Paciente_idPaciente") // 1:1 por paciente
  tipo               AnamnesisTipo @map("tipo")

  // üîπ Resumen cl√≠nico m√≠nimo (vista r√°pida / filtros)
  motivoConsulta            String?            @map("motivo_consulta")
  tieneDolorActual          Boolean            @default(false) @map("tiene_dolor_actual")
  dolorIntensidad           Int?               @map("dolor_intensidad") // 1‚Äì10
  urgenciaPercibida         AnamnesisUrgencia? @map("urgencia_percibida")
  tieneEnfermedadesCronicas Boolean            @default(false) @map("tiene_enfermedades_cronicas")
  tieneAlergias             Boolean            @default(false) @map("tiene_alergias")
  tieneMedicacionActual     Boolean            @default(false) @map("tiene_medicacion_actual")
  embarazada                Boolean?           @map("embarazada") // solo ADULTO femenino
  expuestoHumoTabaco        Boolean?           @map("expuesto_humo_tabaco") // √∫til para ni√±os
  bruxismo                  Boolean?           @map("bruxismo")
  higieneCepilladosDia      Int?               @map("higiene_cepillados_dia")
  usaHiloDental             Boolean?           @map("usa_hilo_dental")
  ultimaVisitaDental        DateTime?          @map("ultima_visita_dental")

  // üîπ Datos pedi√°tricos clave (si tipo = PEDIATRICO)
  tieneHabitosSuccion Boolean? @map("tiene_habitos_succion") // chupete/dedo
  lactanciaRegistrada Boolean? @map("lactancia_registrada")

  // üîπ Payload completo por secciones (estructura JSON flexible) - kept for backward compatibility and custom notes
  payload Json? @map("payload")

  // üîπ Trazabilidad
  creadoPorUserId      Int      @map("Usuario_idUsuario_creadoPor")
  actualizadoPorUserId Int?     @map("Usuario_idUsuario_actualizadoPor")
  creadoPor            Usuario  @relation("AnamnesisCreadaPor", fields: [creadoPorUserId], references: [idUsuario])
  actualizadoPor       Usuario? @relation("AnamnesisActualizadaPor", fields: [actualizadoPorUserId], references: [idUsuario])

  paciente Paciente @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // üîπ Auditor√≠a y versionado
  versionNumber   Int       @default(1) @map("version_number")
  isDeleted       Boolean   @default(false) @map("is_deleted")
  deletedAt       DateTime? @map("deleted_at")
  deletedByUserId Int?      @map("Usuario_idUsuario_deletedBy")
  deletedReason   String?   @map("deleted_reason")
  deletedBy       Usuario?  @relation("AnamnesisDeletedBy", fields: [deletedByUserId], references: [idUsuario])

  // Historial de versiones
  versiones PatientAnamnesisVersion[]

  // Normalized relationships
  antecedents AnamnesisAntecedent[]
  medications AnamnesisMedication[]
  allergies   AnamnesisAllergy[]

  // Auditor√≠a
  auditLogs AnamnesisAuditLog[]

  // Status management
  status               AnamnesisStatus @default(VALID) @map("status")
  lastVerifiedAt       DateTime?       @map("last_verified_at")
  lastVerifiedByUserId Int?            @map("Usuario_idUsuario_lastVerifiedBy")
  lastVerifiedBy       Usuario?        @relation("AnamnesisLastVerifiedBy", fields: [lastVerifiedByUserId], references: [idUsuario])

  // Pending review flags
  hasPendingReviews   Boolean   @default(false) @map("has_pending_reviews")
  pendingReviewReason String?   @map("pending_review_reason")
  pendingReviewSince  DateTime? @map("pending_review_since")

  // Pending reviews
  pendingReviews AnamnesisPendingReview[]

  @@index([tipo])
  @@index([tieneEnfermedadesCronicas, tieneAlergias])
  @@index([urgenciaPercibida])
  @@index([pacienteId, updatedAt]) // Para obtener anamnesis m√°s reciente por paciente
  @@index([tieneDolorActual, urgenciaPercibida]) // Para filtros de urgencia
  @@index([versionNumber])
  @@index([isDeleted, deletedAt])
  @@index([status])
  @@index([hasPendingReviews])
  @@map("PatientAnamnesis")
}

model PatientAnamnesisVersion {
  idPatientAnamnesisVersion Int           @id @default(autoincrement()) @map("idPatientAnamnesisVersion")
  pacienteId                Int           @map("Paciente_idPaciente")
  anamnesisId               Int           @map("PatientAnamnesis_id")
  consultaId                Int?          @map("Consulta_Cita_idCita") // opcional: si se actualiz√≥ en una consulta concreta
  tipo                      AnamnesisTipo @map("tipo")

  // Copia congelada de los campos resumen
  motivoConsulta            String?            @map("motivo_consulta")
  tieneDolorActual          Boolean            @default(false) @map("tiene_dolor_actual")
  dolorIntensidad           Int?               @map("dolor_intensidad")
  urgenciaPercibida         AnamnesisUrgencia? @map("urgencia_percibida")
  tieneEnfermedadesCronicas Boolean            @default(false) @map("tiene_enfermedades_cronicas")
  tieneAlergias             Boolean            @default(false) @map("tiene_alergias")
  tieneMedicacionActual     Boolean            @default(false) @map("tiene_medicacion_actual")
  embarazada                Boolean?           @map("embarazada")
  expuestoHumoTabaco        Boolean?           @map("expuesto_humo_tabaco")
  bruxismo                  Boolean?           @map("bruxismo")
  higieneCepilladosDia      Int?               @map("higiene_cepillados_dia")
  usaHiloDental             Boolean?           @map("usa_hilo_dental")
  ultimaVisitaDental        DateTime?          @map("ultima_visita_dental")
  tieneHabitosSuccion       Boolean?           @map("tiene_habitos_succion")
  lactanciaRegistrada       Boolean?           @map("lactancia_registrada")

  // Snapshot completo del formulario
  payload Json @map("payload")

  motivoCambio String? @map("motivo_cambio") // ej: "control anual", "pre-operatorio"

  // üîπ Campos de auditor√≠a mejorados
  versionNumber         Int     @map("version_number")
  changeSummary         Json?   @map("change_summary")
  restoredFromVersionId Int?    @map("restored_from_version_id")
  ipAddress             String? @map("ip_address")
  userAgent             String? @map("user_agent")
  reason                String? @map("reason")

  creadoPorUserId Int     @map("Usuario_idUsuario_creadoPor")
  creadoPor       Usuario @relation(fields: [creadoPorUserId], references: [idUsuario])

  paciente            Paciente                  @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  anamnesis           PatientAnamnesis          @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)
  consulta            Consulta?                 @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)
  restoredFromVersion PatientAnamnesisVersion?  @relation("AnamnesisVersionRestoredFrom", fields: [restoredFromVersionId], references: [idPatientAnamnesisVersion], onDelete: SetNull)
  restoredVersions    PatientAnamnesisVersion[] @relation("AnamnesisVersionRestoredFrom")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([pacienteId, createdAt])
  @@index([consultaId])
  @@index([anamnesisId, createdAt])
  @@index([tipo, createdAt]) // Para reportes por tipo
  @@index([urgenciaPercibida, createdAt]) // Para an√°lisis de urgencias hist√≥ricas
  @@index([versionNumber])
  @@index([restoredFromVersionId])
  @@map("PatientAnamnesisVersion")
}

// üîπ Sistema de Auditor√≠a Completo para Anamnesis
model AnamnesisAuditLog {
  idAnamnesisAuditLog Int @id @default(autoincrement()) @map("idAnamnesisAuditLog")
  anamnesisId         Int @map("PatientAnamnesis_id")
  pacienteId          Int @map("Paciente_idPaciente") // Denormalizado para consultas r√°pidas

  // Acci√≥n realizada
  action AnamnesisAuditAction @map("action")

  // Actor (qui√©n)
  actorId   Int       @map("Usuario_idUsuario_actor")
  actorRole RolNombre @map("actor_role") // Denormalizado para filtros r√°pidos

  // Contexto de la operaci√≥n
  ipAddress   String? @map("ip_address")
  userAgent   String? @map("user_agent")
  sessionId   String? @map("session_id") // Opcional: ID de sesi√≥n NextAuth
  requestPath String? @map("request_path") // Ruta API que gener√≥ la acci√≥n

  // Cambios realizados
  previousState  Json? @map("previous_state") // Estado completo antes del cambio
  newState       Json? @map("new_state") // Estado completo despu√©s del cambio
  fieldDiffs     Json? @map("field_diffs") // Array de cambios campo por campo
  changesSummary Json? @map("changes_summary") // Resumen estructurado de cambios

  // Metadatos adicionales
  reason     String?                  @map("reason") // Raz√≥n del cambio
  severity   AnamnesisChangeSeverity? @map("severity")
  consultaId Int?                     @map("Consulta_Cita_idCita") // Si el cambio ocurri√≥ en una consulta

  // Context for outside-consultation edits
  isOutsideConsultation Boolean            @default(false) @map("is_outside_consultation")
  informationSource     InformationSource? @map("information_source")
  verifiedWithPatient   Boolean?           @map("verified_with_patient")
  requiresReview        Boolean            @default(false) @map("requires_review")
  reviewedAt            DateTime?          @map("reviewed_at")
  reviewedByUserId      Int?               @map("Usuario_idUsuario_reviewedBy")
  reviewedBy            Usuario?           @relation("AnamnesisReviewedBy", fields: [reviewedByUserId], references: [idUsuario])

  // Versionado
  previousVersionNumber Int? @map("previous_version_number")
  newVersionNumber      Int? @map("new_version_number")

  // Integridad
  integrityHash String? @map("integrity_hash") // Hash SHA-256 del registro

  // Timestamp
  performedAt DateTime @default(now()) @map("performed_at")

  // Pending reviews
  pendingReviews AnamnesisPendingReview[]

  // Relaciones
  anamnesis PatientAnamnesis @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)
  paciente  Paciente         @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  actor     Usuario          @relation("AnamnesisAuditLogActor", fields: [actorId], references: [idUsuario])
  consulta  Consulta?        @relation(fields: [consultaId], references: [citaId], onDelete: SetNull)

  // Relaci√≥n con field diffs
  fieldDiffsDetails AnamnesisFieldDiff[]

  // √çndices para consultas eficientes
  @@index([anamnesisId, performedAt])
  @@index([pacienteId, performedAt])
  @@index([actorId, performedAt])
  @@index([action, performedAt])
  @@index([consultaId])
  @@index([severity, performedAt])
  @@index([performedAt]) // Para particionado futuro por fecha
  @@map("AnamnesisAuditLog")
}

model AnamnesisFieldDiff {
  idAnamnesisFieldDiff Int @id @default(autoincrement()) @map("idAnamnesisFieldDiff")
  auditLogId           Int @map("AnamnesisAuditLog_id")

  fieldPath  String @map("field_path") // Ej: "motivoConsulta", "womenSpecific.embarazada"
  fieldLabel String @map("field_label") // Etiqueta legible: "Motivo de consulta"
  fieldType  String @map("field_type") // "string", "boolean", "number", "object", "array"

  oldValue        Json?   @map("old_value")
  newValue        Json?   @map("new_value")
  oldValueDisplay String? @map("old_value_display") // Valor formateado para UI
  newValueDisplay String? @map("new_value_display")

  isCritical Boolean         @default(false) @map("is_critical")
  changeType FieldChangeType @map("change_type")

  requiresReview Boolean @default(false) @map("requires_review")
  reviewReason   String? @map("review_reason")

  auditLog AnamnesisAuditLog @relation(fields: [auditLogId], references: [idAnamnesisAuditLog], onDelete: Cascade)

  @@index([auditLogId])
  @@index([fieldPath])
  @@index([isCritical])
  @@index([requiresReview])
  @@map("AnamnesisFieldDiff")
}

// Pending review tracking for anamnesis changes outside consultation
model AnamnesisPendingReview {
  idAnamnesisPendingReview Int                     @id @default(autoincrement()) @map("idAnamnesisPendingReview")
  anamnesisId              Int                     @map("PatientAnamnesis_id")
  pacienteId               Int                     @map("Paciente_idPaciente")
  auditLogId               Int                     @map("AnamnesisAuditLog_id")
  fieldPath                String                  @map("field_path")
  fieldLabel               String                  @map("field_label")
  oldValue                 Json?                   @map("old_value")
  newValue                 Json?                   @map("new_value")
  reason                   String                  @map("reason")
  severity                 AnamnesisChangeSeverity @map("severity")
  createdByUserId          Int                     @map("Usuario_idUsuario_createdBy")
  createdAt                DateTime                @default(now()) @map("created_at")

  reviewedAt       DateTime? @map("reviewed_at")
  reviewedByUserId Int?      @map("Usuario_idUsuario_reviewedBy")
  reviewNotes      String?   @map("review_notes")
  isApproved       Boolean?  @map("is_approved")

  anamnesis  PatientAnamnesis  @relation(fields: [anamnesisId], references: [idPatientAnamnesis], onDelete: Cascade)
  paciente   Paciente          @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  auditLog   AnamnesisAuditLog @relation(fields: [auditLogId], references: [idAnamnesisAuditLog], onDelete: Cascade)
  createdBy  Usuario           @relation("AnamnesisPendingReviewCreatedBy", fields: [createdByUserId], references: [idUsuario])
  reviewedBy Usuario?          @relation("AnamnesisPendingReviewReviewedBy", fields: [reviewedByUserId], references: [idUsuario])

  @@index([anamnesisId, reviewedAt])
  @@index([pacienteId, reviewedAt])
  @@index([createdAt])
  @@index([isApproved])
  @@map("AnamnesisPendingReview")
}
