generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rol {
  idRol     Int       @id @default(autoincrement()) @map("idRol")
  nombreRol RolNombre @unique @map("nombreRol")
  usuarios  Usuario[]

  @@map("Rol")
}

/// *
/// * Tabla Usuarios
model Usuario {
  idUsuario      Int          @id @default(autoincrement()) @map("idUsuario")
  usuario        String       @unique @map("usuario")
  email          String?      @unique @map("email")
  passwordHash   String
  nombreApellido String       @map("nombre_apellido")
  rolId          Int          @map("Rol_idRol")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  estaActivo     Boolean      @default(true) @map("esta_activo")
  ultimoLoginAt  DateTime?    @map("ultimo_login_at")
  profesional    Profesional?
  rol            Rol          @relation(fields: [rolId], references: [idRol])

  @@index([rolId])
  @@map("Usuario")
  Cita Cita[]
}

model Profesional {
  idProfesional  Int                       @id @default(autoincrement()) @map("idProfesional")
  numeroLicencia String?                   @unique @map("numeroLicencia")
  estaActivo     Boolean                   @default(true) @map("estaActivo")
  userId         Int                       @unique @map("Usuario_idUsuario")
  personaId      Int                       @unique @map("Persona_idPersona")
  createdAt      DateTime                  @default(now()) @map("created_at")
  disponibilidad Json?                     @map("disponibilidad")
  updatedAt      DateTime                  @updatedAt @map("updated_at")
  persona        Persona                   @relation(fields: [personaId], references: [idPersona])
  usuario        Usuario                   @relation(fields: [userId], references: [idUsuario], onDelete: Cascade)
  especialidades ProfesionalEspecialidad[]

  @@index([estaActivo])
  @@map("Profesional")
  Cita Cita[]
}

model Persona {
  idPersona       Int               @id @default(autoincrement()) @map("idPersona")
  nombres         String            @map("nombres")
  apellidos       String            @map("apellidos")
  fechaNacimiento DateTime?         @map("fecha_nacimiento")
  genero          Genero?           @map("genero")
  direccion       String?           @map("direccion")
  estaActivo      Boolean           @default(true) @map("esta_activo")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  documento       Documento?
  contactos       PersonaContacto[]
  profesionales   Profesional?

  @@index([nombres, apellidos])
  @@map("Persona")
  Paciente Paciente[]
  PacienteResponsable PacienteResponsable[]
}

model Documento {
  idDocumento      Int           @id @default(autoincrement()) @map("idDocumento")
  personaId        Int           @unique @map("Persona_idPersona")
  tipo             TipoDocumento @map("tipo")
  numero           String        @map("numero")
  paisEmision      String?       @map("pais_emision")
  fechaEmision     DateTime?     @map("fecha_emision")
  fechaVencimiento DateTime?     @map("fecha_vencimiento")
  ruc              String?       @map("ruc")
  persona          Persona       @relation(fields: [personaId], references: [idPersona], onDelete: Cascade)

  @@unique([tipo, numero, paisEmision])
  @@map("Documento")
}

model PersonaContacto {
  idContacto              Int          @id @default(autoincrement()) @map("idContacto")
  personaId               Int          @map("Persona_idPersona")
  tipo                    TipoContacto @map("tipo")
  valorRaw                String       @map("valor_raw")
  valorNorm               String       @map("valor_norm")
  label                   String?      @map("label")
  whatsappCapaz           Boolean?     @map("whatsapp_capaz")
  smsCapaz                Boolean?     @map("sms_capaz")
  esPrincipal             Boolean      @default(false) @map("es_principal")
  esPreferidoRecordatorio Boolean      @default(false) @map("es_pref_recordatorio")
  esPreferidoCobranza     Boolean      @default(false) @map("es_pref_cobranza")
  activo                  Boolean      @default(true) @map("activo")
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")
  persona                 Persona      @relation(fields: [personaId], references: [idPersona], onDelete: Cascade)

  @@unique([personaId, tipo, valorNorm])
  @@index([personaId, tipo, esPrincipal])
  @@index([personaId, esPreferidoRecordatorio])
  @@index([personaId, esPreferidoCobranza])
  @@map("PersonaContacto")
}

model Especialidad {
  idEspecialidad Int                       @id @default(autoincrement()) @map("idEspecialidad")
  nombre         String                    @unique @map("nombre")
  descripcion    String?                   @map("descripcion")
  isActive       Boolean                   @default(true) @map("is_active")
  profesionales  ProfesionalEspecialidad[]

  @@map("Especialidad")
}

model ProfesionalEspecialidad {
  profesionalId  Int
  especialidadId Int
  especialidad   Especialidad @relation(fields: [especialidadId], references: [idEspecialidad])
  profesional    Profesional  @relation(fields: [profesionalId], references: [idProfesional], onDelete: Cascade)

  @@id([profesionalId, especialidadId])
  @@map("ProfesionalEspecialidad")
}

enum RolNombre {
  ADMIN
  ODONT
  RECEP
}

enum Genero {
  MASCULINO
  FEMENINO
  OTRO
  NO_ESPECIFICADO
}

enum TipoDocumento {
  CI
  DNI
  PASAPORTE
  RUC
  OTRO
}

enum TipoContacto {
  PHONE
  EMAIL
}

enum RelacionPaciente {
  PADRE
  MADRE
  TUTOR
  CONYUGE
  FAMILIAR
  OTRO
}

enum TipoCita {
  CONSULTA
  LIMPIEZA
  ENDODONCIA
  EXTRACCION
  URGENCIA
  ORTODONCIA
  CONTROL
  OTRO
}

enum EstadoCita {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ======== MODELOS ========

// Paciente
model Paciente {
  idPaciente   Int       @id @default(autoincrement()) @map("idPaciente")
  personaId    Int       @unique                      @map("Persona_idPersona")
  notas        String?   @map("notas")
  estaActivo   Boolean   @default(true)               @map("esta_activo")
  createdAt    DateTime  @default(now())              @map("created_at")
  updatedAt    DateTime  @updatedAt                   @map("updated_at")

  persona      Persona   @relation(fields: [personaId], references: [idPersona])
  responsables PacienteResponsable[]
  citas        Cita[]    // <— importante: relación inversa (solo lectura)

  @@map("Paciente")
}

// Responsable de pago / tutor
model PacienteResponsable {
  idPacienteResponsable Int               @id @default(autoincrement()) @map("idPacienteResponsable")
  pacienteId            Int               @map("Paciente_idPaciente")
  personaId             Int               @map("Persona_idPersona")
  relacion              RelacionPaciente  @map("relacion")
  esPrincipal           Boolean           @default(false)               @map("es_principal")
  autoridadLegal        Boolean           @default(false)               @map("autoridad_legal")
  vigenteDesde          DateTime          @default(now())               @map("vigente_desde")
  vigenteHasta          DateTime?         @map("vigente_hasta")
  notas                 String?           @map("notas")
  createdAt             DateTime          @default(now())               @map("created_at")
  updatedAt             DateTime          @updatedAt                    @map("updated_at")

  paciente              Paciente          @relation(fields: [pacienteId], references: [idPaciente], onDelete: Cascade)
  persona               Persona           @relation(fields: [personaId], references: [idPersona])

  @@index([pacienteId, personaId])
  @@map("PacienteResponsable")
}

// Consultorio / Box
model Consultorio {
  idConsultorio Int      @id @default(autoincrement()) @map("idConsultorio")
  nombre        String   @unique                       @map("nombre")
  colorHex      String?  @map("color_hex")
  activo        Boolean  @default(true)                @map("activo")
  createdAt     DateTime @default(now())               @map("created_at")
  updatedAt     DateTime @updatedAt                    @map("updated_at")

  citas         Cita[]

  @@map("Consultorio")
}

// Cita / Turno
model Cita {
  idCita          Int          @id @default(autoincrement()) @map("idCita")

  // FKs ESCALARES (deben existir para poder enviar ids sueltos en create)
  pacienteId      Int          @map("Paciente_idPaciente")
  profesionalId   Int          @map("Profesional_idProfesional")
  consultorioId   Int?         @map("Consultorio_idConsultorio")
  createdByUserId Int          @map("Usuario_idUsuario_createdBy")

  inicio          DateTime     @map("inicio")
  fin             DateTime     @map("fin")
  tipo            TipoCita     @map("tipo")
  estado          EstadoCita   @default(SCHEDULED)          @map("estado")
  motivo          String?      @map("motivo")
  notas           String?      @map("notas")
  createdAt       DateTime     @default(now())              @map("created_at")
  updatedAt       DateTime     @updatedAt                   @map("updated_at")

  // RELACIONES con fields/references correctamente enlazadas
  paciente        Paciente     @relation(fields: [pacienteId], references: [idPaciente])
  profesional     Profesional  @relation(fields: [profesionalId], references: [idProfesional])
  consultorio     Consultorio? @relation(fields: [consultorioId], references: [idConsultorio])
  creadoPor       Usuario      @relation(fields: [createdByUserId], references: [idUsuario])

  @@index([profesionalId, inicio])
  @@index([pacienteId, inicio])
  @@index([consultorioId, inicio])
  @@index([estado, inicio])
  @@map("Cita")
}


